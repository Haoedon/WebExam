<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Оформление заказа</title>
    <link rel="stylesheet" href="styles.css">
</head>
<body>
<header>
    <h1>Оформить заказ</h1>
    <nav class="list-box">
        <a href="index.html" class="button">Главная</a>
        <a href="catalog.html" class="button">Каталог</a>
    </nav>
</header>

<main class="container" style="display:flex; gap:20px; align-items:flex-start;">
    <section style="flex:1;">
        <h2>Состав заказа</h2>
        <div id="orderItems">
            <p class="empty-cart">Загрузка...</p>
        </div>
    </section>

    <section style="width:420px;">
        <h2>Оформление заказа</h2>
        <form id="orderForm" class="feedback-form" action="save_order.php" method="POST">
            <input type="hidden" id="cartData" name="cart_data">

            <div id="selectedSummary" style="margin-bottom:12px; background:#fff; padding:10px; border-radius:8px;">
                <strong>Выбранные позиции:</strong>
                <div id="selectedList"></div>
                <div style="text-align:right; margin-top:8px;">Итог: <strong id="finalTotal">0 ₽</strong></div>
            </div>

            <div class="form-group">
                <label for="fio">ФИО</label>
                <input type="text" id="fio" name="fio" class="form-control" required>
            </div>

            <div class="form-group">
                <label for="email">Email</label>
                <input type="email" id="email" name="email" class="form-control" required>
            </div>

            <div class="form-group">
                <label for="phone">Номер Телефона</label>
                <input type="tel" id="phone" name="phone" class="form-control" required>
            </div>

            <div class="form-group">
                <div class="checkbox-group">
                    <label><input type="checkbox" name="consent" required> Даю согласие на обработку персональных данных</label>
                </div>
            </div>

            <button type="submit" class="btn" id="submitOrder">Отправить</button>
        </form>
    </section>
</main>

<footer>
    <p style="text-align:center; padding:20px 0;">Контакты и информация</p>
</footer>

<script src="car-sorting.js"></script>
<script>
    // Load cars and render order page
    document.addEventListener('DOMContentLoaded', function() {
        loadCars().then(cars => {
            carsData = cars;
            renderOrderItems();
        });

        function renderOrderItems() {
            const ids = getCartIds();
            const container = document.getElementById('orderItems');
            const selectedList = document.getElementById('selectedList');
            const finalTotal = document.getElementById('finalTotal');
            if (!container) return;
            container.innerHTML = '';
            if (ids.length === 0) {
                container.innerHTML = '<p class="empty-cart">Ничего не выбрано. Чтобы добавить товар в заказ, перейдите на страницу <a href="catalog.html">Оформить заказ</a>.</p>';
                selectedList.innerHTML = '';
                finalTotal.textContent = '0 ₽';
                return;
            }
            let total = 0;
            ids.forEach(id => {
                const car = carsData.find(c => c.latinName === id);
                if (!car) return;
                total += car.priceValue || 0;
                const el = document.createElement('div');
                el.className = 'car-item';
                el.style.marginBottom = '12px';
                el.innerHTML = `
                    <img src="${car.image}" alt="${car.name}" style="width:120px; height:80px; object-fit:cover; float:left; margin-right:10px; border-radius:8px;">
                    <div style="overflow:hidden;">
                        <strong>${car.name}</strong>
                        <div class="car-specs">${car.specs}</div>
                        <div class="car-price">${car.price}</div>
                        <button class="remove-btn" data-latin="${car.latinName}" style="margin-top:8px;">Удалить</button>
                    </div>
                    <div style="clear:both"></div>
                `;
                container.appendChild(el);
            });
            // selected list in the form
            selectedList.innerHTML = ids.map(id => {
                const c = carsData.find(x => x.latinName === id);
                if (!c) return '';
                return `<div style="display:flex; justify-content:space-between; padding:6px 0;">${c.name} <span>${c.price}</span></div>`;
            }).join('');
            finalTotal.textContent = formatPrice(total) + ' ₽';

            // attach delete handlers
            document.querySelectorAll('.remove-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    const latin = this.getAttribute('data-latin');
                    removeIdFromCart(latin);
                    renderOrderItems();
                    // also try to update catalog UI if open
                    try { refreshCheckoutPanel(); } catch(e){}
                });
            });

            // prepare hidden cart data for submit
            const cartDataInput = document.getElementById('cartData');
            if (cartDataInput) cartDataInput.value = JSON.stringify({ cars: ids, timestamp: new Date().toISOString() });
        }

        // form submit with combo validation
        const form = document.getElementById('orderForm');
        form.addEventListener('submit', function(e) {
            const ids = getCartIds();
            if (!isValidCombo(ids)) {
                e.preventDefault();
                alert('Состав заказа не соответствует ни одному доступному комбо. Пожалуйста, измените состав.');
                return false;
            }
            // allow normal submit (will send to httpbin)
            // after submit we can clear cart
            // but better to handle via fetch to clear on success
            e.preventDefault();
            const formData = new FormData(form);
            formData.set('cart_data', JSON.stringify({ cars: ids }));
            fetch(form.action, { method: 'POST', body: formData })
                .then(r => r.json())
                .then(resp => {
                    if (resp.success) {
                        alert('Заказ #' + resp.order_id + ' успешно сохранен');
                        localStorage.removeItem(CART_KEY);
                        window.location.href = 'catalog.html';
                    } else {
                        alert('Ошибка: ' + (resp.error || 'Неизвестная ошибка'));
                    }
                })
                .catch(err => {
                    alert('Ошибка отправки заказа: ' + err.message);
                });
        });
    });
</script>
</body>
</html>
